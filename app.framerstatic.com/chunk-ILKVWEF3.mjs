import{b as $}from"https://app.framerstatic.com/chunk-HMVPZBUZ.mjs";import{a as C}from"https://app.framerstatic.com/chunk-QXZEZGIB.mjs";import{x as k,y as M}from"https://app.framerstatic.com/chunk-4KWXHJXI.mjs";import{g as v}from"https://app.framerstatic.com/chunk-ELABTCIQ.mjs";import{b as A,c as I}from"https://app.framerstatic.com/chunk-UNOTV3A5.mjs";import{e as j}from"https://app.framerstatic.com/chunk-D7MEQ7Y3.mjs";import{d as o}from"https://app.framerstatic.com/chunk-GSK5BUJZ.mjs";import{a as m}from"https://app.framerstatic.com/chunk-7GSEC7H4.mjs";import{h as R}from"https://app.framerstatic.com/chunk-FKVUZ4GS.mjs";import{a as T}from"https://app.framerstatic.com/chunk-TBB27SWX.mjs";import{e as b,t as w}from"https://app.framerstatic.com/chunk-IFLV2SXW.mjs";import{a as f}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{a as l}from"https://app.framerstatic.com/chunk-DFNFZLDR.mjs";import{e as E,j as g}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var u=E(T());async function S(i,e,s,t){let a=`upload${Math.random()}`;try{t({type:"add",key:a,variant:"progress",icon:s,text:"Uploading remote file\u2026",duration:1/0,showCloseButton:"never"});let r=await o.post(i,{url:e});return t({type:"add",key:a,variant:"success",text:"File has been uploaded",duration:1e4,icon:"success",moveToTop:!0}),r}catch(r){throw t({type:"add",key:a,variant:"error",text:"Error uploading file",duration:3e4,icon:"error",moveToTop:!0}),r}}var d=w("useAPI"),N=j()&&navigator.userAgent.includes("Version/16"),q=window.CompressionStream&&!N,P=class extends Error{},y=class{constructor(e,s,t=m){this.socket=e;this.projectId=s;this.dispatch=t;g(this,"apiBaseURL",l().api);g(this,"packagesPerPage",36)}wait(e){o.wait(e)}getACL(){o.get(`/web/projects/${this.projectId}/acl/`).then(({users:e,invites:s,accessRequests:t})=>{this.dispatch({type:"resetACL",acl:[...e.map(a=>({...a,kind:"user"})),...s.map(a=>({...a,kind:"invite"}))],accessRequests:t.map(a=>({...a,kind:"accessRequest"}))})}).catch(e=>d.error("Failed to get ACL:",e))}setInitialProject(e){e.then(s=>{this.dispatch({type:"setProject",project:s})}).catch(s=>d.error("Failed to set initial project:",s))}getProject(){o.get(`/web/projects/${this.projectId}`).then(e=>{this.dispatch({type:"setProject",project:e})}).catch(e=>d.error("Failed to get project:",e))}async pollProject({intervalMillis:e,attempts:s,stopCondition:t}){for(let a=0;a<s;++a){let r=await o.get(`/web/projects/${this.projectId}`);if(t(r)){this.dispatch({type:"setProject",project:r}),this.notifyProjectChange("metadata");return}await b(e)}throw new P("pollProject exceeded the number of attempts")}async inviteByEmail(e){let s=await k(this.projectId,e);return s.status===0&&(this.dispatch({type:"updateACL",acl:[s.aclEntry]}),this.notifyProjectChange("acl")),s}async removeInvite({id:e}){await o.deleteRaw(`/web/projects/${this.projectId}/invites/${e}`),this.notifyProjectChange("acl"),this.getACL()}async updateUserPermissions(e){let s=await M(this.projectId,e);return s.status===0&&(this.notifyProjectChange("acl"),this.getACL()),s}async requestAccess(e){let s=await C(e);return this.notifyProjectChange("acl"),s}async grantProjectAccessRequest({id:e}){let s=await A(e);return s.status===0&&(this.notifyProjectChange("acl"),this.getACL()),s}async denyProjectAccessRequest({id:e}){let s=await I(e);return s.status===0&&(this.notifyProjectChange("acl"),this.getACL()),s}async forceRefreshACL(){this.notifyProjectChange("acl"),this.getACL()}async removeUserPermissions({id:e}){await o.deleteRaw(`/web/projects/${this.projectId}/acl/${e}`),this.notifyProjectChange("acl"),this.getACL()}async updateProject(e,s=!0){s&&this.dispatch({type:"updateProject",changes:e});try{await $(this.projectId,e),this.getProject(),this.notifyProjectChange("metadata")}catch(t){throw d.error("Failed to update project:",t),t}}async subscribeToNotifications(){await o.postRaw(`/web/projects/${this.projectId}/threads/notifications/subscribe`)}async unsubscribeFromNotifications(){await o.postRaw(`/web/projects/${this.projectId}/threads/notifications/unsubscribe`)}async getAssets(){let e=await o.get(`/web/projects/${this.projectId}/assets/`);if(!Array.isArray(e.assets)){let s=new Error("malformed /projects/./assets/ response");throw d.reportError(s,e),s}return e}async uploadAsset(e,{maxFileSize:s,onExceedsCustomMaxSize:t,onToast:a=m}={}){let r=new URL(`/web/projects/${this.projectId}/assets`,this.apiBaseURL).href,n=await v({endpoint:r,fieldName:"file",file:e,icon:"image",onToast:a,customMaxSize:s,onExceedsCustomMaxSize:t});return n&&this.notifyProjectChange("assets"),n}async uploadAssetByURL(e,s=m){let t=await S(`/web/projects/${this.projectId}/assets/fetch`,e,"image",s);return t&&this.notifyProjectChange("assets"),t}async duplicateAssets(e,s){if(this.projectId===s)return d.warn("Attempted to duplicate assets for current project"),[];let t=await o.post(`/web/projects/${this.projectId}/assets/duplicate`,{sourceProjectId:s,keys:e});return t&&this.notifyProjectChange("assets"),t.assets}async deleteAsset(e){let s=await o.deleteRaw(`/web/projects/${this.projectId}/assets/${e}`);return s&&this.notifyProjectChange("assets"),s}async createModule(e){let s=new FormData;return this.addModuleRequestToForm(e,s),await o.postRaw("/modules/v1/modules/",s).then(a=>a.json())}async deleteModule({moduleId:e}){return await o.deleteRaw(`/modules/v1/modules/${e}`).then(t=>t.json())}async getModule({moduleId:e,saveId:s}){let t;return s?t=`/modules/v1/modules/${e}/saves/${s}`:t=`/modules/v1/modules/${e}`,o.get(t)}async getModuleDependencies({moduleId:e,saveId:s}){return o.get(`/modules/v1/modules/${e}/saves/${s}/dependencies/`)}async listModules({types:e}={}){let s=new URLSearchParams;if(e)for(let a of e)s.append("type",a);return await o.get(`/modules/v1/modules/?${s.toString()}`,{projectId:this.projectId})}async listNamespaces(){return await o.get("/modules/v1/namespaces/")}async listPublishedModules({namespace:e}){let s=`/modules/v1/modules/namespaces/${encodeURIComponent(e)}/published/`;return await o.get(s)}async lookUpModules(e){return o.post("/modules/v1/modules/batch/lookup/",e)}async publishModule({namespace:e,name:s,...t}){let a=`/modules/v1/namespaces/${encodeURIComponent(e)}/published/${encodeURIComponent(s)}`;return await o.post(a,t)}async updateModule({moduleId:e,...s}){return await o.post(`/modules/v1/modules/${e}`,s)}async saveModule(e){let s=new FormData;return await this.addModuleRequestToForm(e,s),await o.postRaw(`/modules/v1/modules/${e.moduleId}/saves/`,s).then(a=>a.json())}async saveModules({batch:e}){let s=new FormData;return await Promise.all(e.map(a=>this.addModuleRequestToForm(a,s))),await o.postRaw("/modules/v1/modules/batch/saves/",s).then(a=>a.json())}async addModuleRequestToForm(e,s){let{files:t,...a}=e,r=s.getAll("metadata").length;q&&window.CompressionStream&&(a.transferEncoding="gzip"),s.append("metadata",JSON.stringify({...a,projectId:this.projectId,files:t.map(({content:n,bytes:c,...p})=>p)})),await Promise.all(t.map(async n=>{let c=n.content??n.bytes;f(!R(c),"File needs content or bytes");let p=new Blob([c]);if(q&&window.CompressionStream){let L=new window.CompressionStream("gzip"),U=p.stream();p=await new Response(U.pipeThrough(L)).blob();let h=c.length-p.size,F=h/c.length*100;d.debug("Saved",h,"bytes",`(${F.toFixed(1)}%)`,"compressing",n.name)}s.append(`files[${r}]`,new File([p],n.name))}))}async getFileList(){return o.getRaw(`/web/vekter/projects/${this.projectId}/files`)}async getFile(e){return o.getRaw(`/web/vekter/projects/${this.projectId}/files/${e}`)}async saveFile(e,s){let t=new FormData,a=new File([s],e,{type:"text/plain"});return t.set("file",a),o.postRaw(`/web/vekter/projects/${this.projectId}/files/${e}`,t,void 0)}async deleteFile(e){return o.deleteRaw(`/web/vekter/projects/${this.projectId}/files/${e}`)}async getBuildOutput(e){return o.getRaw(`/web/projects/${this.projectId}/files/${e}`)}async getPackage(e){let{fromPublicPackages:s,packageName:t}=e;return o.get(`/store/packages${s?"":"/private"}/${t}`)}async deletePackage(e){let{fromPublicPackages:s,packageName:t}=e;await o.deleteRaw(`/store/packages${s?"":"/private"}/${t}`)}async getPackageVersionStatus(e){let{isPrivate:s,packageName:t,version:a}=e;return o.get(`/store/packages${s?"/private":""}/${t}/version/${a}`)}async preflightPackage(e){let{fromPublicPackages:s,body:t}=e;return o.post(`/store/packages${s?"":"/private"}/preflight`,t)}async findPackage(e){let{fromPublicPackages:s,friendlyName:t,spaceId:a}=e;return o.getRaw(`/store/packages${s?"":"/private"}/find-by-slugify`,{name:t,spaceId:a})}async findPackages(e){let{fromPublicPackages:s,query:t,offset:a,spaceIds:r}=e;return o.getRaw(`/store/packages${s?"":"/private"}/search`,{query:t,offset:a,limit:this.packagesPerPage,spaceIds:r})}async favoritePackage(e){let{fromPublicPackages:s,packageName:t}=e;return o.postRaw(`/store/packages${s?"":"/private"}/${t}/favorite`)}async unfavoritePackage(e){let{fromPublicPackages:s,packageName:t}=e;return o.deleteRaw(`/store/packages${s?"":"/private"}/${t}/favorite`)}async getPackages(e){let{fromPublicPackages:s,section:t,offset:a,spaceIds:r}=e;return o.getRaw(`/store/packages${s?"":"/private"}/${t||""}`,{offset:a,limit:this.packagesPerPage,spaceIds:r})}async getPopularPackages(e){let{fromPublicPackages:s,offset:t,days:a,spaceIds:r}=e;return o.getRaw(`/store/packages${s?"":"/private"}/popular`,{offset:t,days:a,limit:this.packagesPerPage,spaceIds:r})}async getFeaturedPackages(e){let{fromPublicPackages:s,offset:t}=e;return o.getRaw(`/store/packages${s?"":"/private"}/`,{featured:!0,offset:t,limit:this.packagesPerPage})}async getPublisherPackages(e){let{publisherId:s,offset:t}=e;return o.getRaw(`/store/packages/published-by/${s}`,{offset:t,limit:this.packagesPerPage})}async getTrendingPackages(){return o.getRaw("/store/packages/trending")}async getPackagesMetadata(e){return o.post("/store/meta/get-many",e)}async listPhotos(e){return o.get("/web/unsplash/photos",e)}async searchPhotos(e){return o.get("/web/unsplash/search/photos",e)}async getRandomPhoto(e){return o.get("/web/unsplash/photos/random",e)}async downloadPhoto(e){return o.get(`/web/unsplash/photos/${e.id}/download`)}notifyProjectChange(e){this.socket.send({type:"notifyProjectChange",value:{scope:e}})}};function oe(i,e,s){let t=(0,u.useMemo)(()=>new y(i,e.projectId,s),[i,e.projectId,s]);(0,u.useEffect)(()=>{t.getACL()},[t]);let a=(0,u.useRef)(e);return a.current=e,(0,u.useEffect)(()=>i.onMessage(r=>{let n=a.current;if(r.type==="join"){if(n.aclById[r.id])return}else if(r.type==="welcome"){if(n.acl.length===0)return;let c=!1;for(let p of n.activeIds)if(!n.aclById[p]){c=!0;break}if(!c)return}else return;t.getACL()}),[t,i]),t}function ie(i){let e=l(),s=new URL(e.app);return s.protocol=s.protocol==="http:"?"ws:":"wss:",s.pathname=`/projects/${i}/socket`,s.href}export{y as a,oe as b,ie as c};
//# sourceMappingURL=https://app.framerstatic.com/chunk-ILKVWEF3.mjs.map
