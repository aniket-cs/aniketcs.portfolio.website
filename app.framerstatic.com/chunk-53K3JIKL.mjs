import{g as ke,h as De}from"https://app.framerstatic.com/chunk-CLVPFFWG.mjs";import{a as Ae,b as Me}from"https://app.framerstatic.com/chunk-B2X7EA3W.mjs";import{c as q,e as Ie,g as Ee}from"https://app.framerstatic.com/chunk-TUVYJ6H5.mjs";import{b as Le,e as P}from"https://app.framerstatic.com/chunk-6GQIEXHH.mjs";import{$ as te,Sg as Pe,ig as _,rd as xe,rg as Ne,sg as re,ug as ne,vg as L,xg as ie}from"https://app.framerstatic.com/chunk-52WXMGQT.mjs";import{f as Re}from"https://app.framerstatic.com/chunk-EZF75KBF.mjs";import{Eb as Se,Ib as ye,Mi as Ce,cm as be,dm as ee,em as we,wa as ve}from"https://app.framerstatic.com/chunk-O5AMU6IS.mjs";import{o as D}from"https://app.framerstatic.com/chunk-WKO4Y66Q.mjs";import{c as Te}from"https://app.framerstatic.com/chunk-XW2R7BKI.mjs";import{a as me,b as ge}from"https://app.framerstatic.com/chunk-PZ4PDPA4.mjs";import{g as O}from"https://app.framerstatic.com/chunk-X5STD3PC.mjs";import{ba as pe,ca as W,e as fe,t as y}from"https://app.framerstatic.com/chunk-J7RAPXVX.mjs";import{a as u,b as ue}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{e as B,j as a}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var se=y("app");function Tt(i){return i.treeReflectsDocument?tt(i.tree):null}function tt(i){return i.toJS()}function St(i){function e(t){let{__class:r,width:n,height:s,top:o,bottom:d,left:h,right:c}=t,{children:l}=t;return l?(l=l.map(e),{__class:r,width:n,height:s,top:o,bottom:d,left:h,right:c,children:l}):t.styledText?{__class:r,width:n,height:s,top:o,bottom:d,left:h,right:c,text:t.styledText.blocks.map(f=>f.text)}:{__class:r,width:n,height:s,top:o,bottom:d,left:h,right:c}}return e(i.tree.toJS().root)}function yt(i){let e,t=new XMLHttpRequest;t.open("GET",i.toString(),!1);try{t.send(),e=JSON.parse(t.responseText)}catch(r){se.error(`Retrieving document \u201C${i}\u201D failed. (${r})`)}return oe(e)}function Fe(i){O.isTest||i.forEach(e=>{se.warn("[repaired]",e)})}function oe(i){let e=[];try{let t=q(i,e);return Fe(e),t}catch(t){throw Fe(e),se.warn("tree failed to verify:",t),t}}var rt=y("DocumentLoader"),ae=y("remote:verify"),H=class{constructor(e,t){this.data=e;this.settings=t;a(this,"parser");a(this,"canvasTreeVersion",0);this.parser=new Me(e),this.canvasTreeVersion=this.parser.version}readFirstPage(){let e=!1,t=[];if(this.settings.activeNodeId&&(t.push(...this.parser.getPagesContainingId(this.settings.activeNodeId)),e=t.some(r=>De(this.parser.getShallowPage(r)))),!e){let r=ke(this.parser.getShallowPages(),this.parser.getHomePageNodeID());t.push(r.id)}return rt.debug("loadPartialDocument():",t),Ee(this.parser,t,this.settings.treeServices)}getScopesToLoad(){return this.parser.getPagesToLoad()}getParsedPageById(e){return this.parser.getParsedPageById(e)}buildPage(e){if(!e)return;let t=[],r=ae.isLoggingTraceMessages()?[]:void 0,n=_(e,this.parser.root.id,{extraChecksAndFixes:!0,errors:t,warnings:r});if(n&&Ie(n,t),t.length>0&&ae.warn("errors loading server tree: "+t.join(`
`)),r&&r.length>0&&ae.trace("warnings loading server tree: "+r.join(`
`)),!!n)return n}};var V=class extends Error{constructor(){super("cancelled"),this.name="CancelledError"}},j=class{constructor(e){this.requestIdleCallback=e;a(this,"resumePromiseResolve");a(this,"resumePromise");a(this,"backgroundMode",!1);a(this,"done",!1);a(this,"firstError");a(this,"debugStepListener")}debugResumeOneStep(){this.resume(),this.pause()}currentMode(){return this.backgroundMode?"slow":"fast"}isDone(){return!!this.firstError||this.done}isSuccess(){return!this.firstError&&this.done}isCancelled(){return!!this.firstError&&this.firstError instanceof V}isError(){return!!this.firstError&&!(this.firstError instanceof V)}getError(){return this.firstError}cancel(){this.isDone()||(this.firstError=new V)}error(e){return this.isDone()||(this.firstError=e),e}pause(){this.firstError||this.resumePromise||(this.resumePromise=new Promise(e=>{this.resumePromiseResolve=e}))}resume(){let e=this.resumePromiseResolve;e&&(this.resumePromise=void 0,this.resumePromiseResolve=void 0,e())}isPaused(){return!!this.resumePromise}fast(){this.backgroundMode=!1}slow(){this.backgroundMode=!0}async run(e){u(!this.isDone(),"task is already done");try{await e()}catch(t){throw t instanceof Error?this.error(t):this.error(new Error(String(t??"Unknown Error")))}finally{this.done=!0}}async sleep(e){if(this.debugStepListener?.(),await fe(e),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}async yield(){if(this.debugStepListener?.(),this.resumePromise?await this.resumePromise:this.backgroundMode?await new Promise(e=>{this.requestIdleCallback?this.requestIdleCallback(e):typeof requestIdleCallback=="function"?requestIdleCallback(e):setTimeout(e,0)}):await W(),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}};var m=y("DocumentLoader"),nt=10,Ue=1e3;function J(i){return i<1024*.75?`${Math.round(i)}b`:i<1024*1024*.75?`${(i/1024).toFixed(2)}kb`:`${(i/1024/1024).toFixed(2)}Mb`}function x(i){return i<200?`${i.toFixed(1)}ms`:i<20*1e3?`${(i/1e3).toFixed(3)}s`:`${Math.round(i/1e3)}s`}var Oe=class extends Le{constructor(t,r,n){super();this.treeVersion=t;this.documentURL=r;this.settings=n;a(this,"scheduler");a(this,"retryCount",0);a(this,"scopesToLoad",new Set);a(this,"prioritizedScopeIds",new Set);a(this,"currentLoadingScope");a(this,"partialParser");a(this,"canvasTreeVersion",0);a(this,"documentSize",0);a(this,"loadedFirstScope",!1);a(this,"loadingDuration",0);a(this,"parsingDuration",0);a(this,"debugPaused",!1);a(this,"loadingScopesPaused",!1);a(this,"loadAllDataPriority",0);a(this,"updatePauseResumeState",()=>{if(!this.loadedFirstScope){this.scheduler.fast(),this.scheduler.resume();return}let t=this.loadAllDataPriority>0||this.prioritizedScopeIds.size>0,r=this.loadingScopesPaused||this.debugPaused;t?this.scheduler.fast():this.scheduler.slow(),t||!r||this.scopesToLoad.size<=0?this.scheduler.resume():this.scheduler.pause()});a(this,"tree");a(this,"loadCallbacksPerScope",new Map);a(this,"addedByDiff",new Set);a(this,"removedByDiff",new Set);this.scheduler=new j(n.requestIdleCallback),m.debug("new:",this.treeVersion,this.documentURL)}pauseLoadingScopes(){this.loadingScopesPaused||(this.loadingScopesPaused=!0,m.debug("pauseLoadingScopes"),this.updatePauseResumeState())}resumeLoadingScopes(){this.loadingScopesPaused&&(this.loadingScopesPaused=!1,m.debug("resumeLoadingScopes"),this.updatePauseResumeState())}prioritizeLoadingAllData(t){let r="preload"in t&&t.preload;if(r&&D.isOn("debugEditWhileNeverLoadingRest"))return()=>{};let n=performance.now(),s=this.numberOfScopesToLoad();this.loadAllDataPriority=Math.max(1,this.loadAllDataPriority+1),m.debug("prioritizeLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState();let o=r||"doNotTrack"in t&&t.doNotTrack,d=!1,h=o?void 0:this.afterAllDataLoaded(()=>{if(d)return;u("operationName"in t,"operationName is required");let l=performance.now()-n;Re("fulltree_force_load",{operationName:t.operationName,durationMs:l,background:t.operationInBackground,shallowScopesCount:s})});return()=>{d||(d=!0,h?.(),this.stopPrioritizingLoadingAllData())}}stopPrioritizingLoadingAllData(){this.loadAllDataPriority-=1,m.debug("stopPrioritizingLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState()}debugPause(){this.debugPaused||(this.debugPaused=!0,m.debug("debugPause"),this.updatePauseResumeState())}debugResume(){this.debugPaused&&(this.debugPaused=!1,m.debug("debugResume"),this.updatePauseResumeState())}isDebugPaused(){return this.debugPaused}afterAllDataLoaded(t){let r=this.scopesToLoad.size===0;if(t){if(r){let n=!1;return queueMicrotask(()=>{n||t()}),()=>{n=!0}}return this.once("loadedAllData",t),()=>{this.off("loadedAllData",t)}}return r?Promise.resolve():new Promise(n=>{this.once("loadedAllData",n)})}async start(){await this.scheduler.run(async()=>{m.debug("start"),P("parsingInit"),this.updatePauseResumeState();let t=performance.now(),r=await this.loadData();if(this.loadingDuration=performance.now()-t,await this.scheduler.yield(),!this.settings.partialParsing||!Ae(r))return this.parseFullDocumentSync(r);let n=await this.loadDocumentVersion(r);for(await this.scheduler.yield(),this.tree=await this.loadFirstTree(n),this.loadedFirstScope=!0,this.updatePauseResumeState(),await this.scheduler.yield(),P("parsingResume");this.hasNextScopeToLoad();)await this.loadNextScopeAsync(n),await this.scheduler.yield();await this.emitWrapped(()=>{u(this.tree,"tree must have been set"),this.tree.setService("loader",void 0),this.emit("loadedAllData")}),m.debug("done",J(this.documentSize),"loading:",x(this.loadingDuration),"parsing:",x(this.parsingDuration))})}async loadData(){if(this.settings.loadedData)return this.settings.loadedData;m.debug("Document in cache is not up to date. Tree version:",this.treeVersion);let t=this.settings.initData,r=t?.version===this.treeVersion,n=t?.prefetchPromise;if(t&&delete t.prefetchPromise,r&&n){m.debug("loadData: prefetch");let h=await n;n.then(l=>l.duration).then(l=>{P("dataLoad",l)}),await this.scheduler.yield();let c=await h.text;return await this.scheduler.yield(),h.status<200&&h.status>=300?this.handleErrorAndRetry(h.status,c):c}m.debug("loadData: fetch");let s;this.settings.refreshAccessToken&&(s=await this.settings.refreshAccessToken({}),await this.scheduler.yield());let o=await fetch(this.documentURL,s);await this.scheduler.yield();let d=await o.text();return await this.scheduler.yield(),P("dataLoad"),o.status<200||o.status>=300?this.handleErrorAndRetry(o.status,d):d}async handleErrorAndRetry(t,r){let n=!1;try{n=JSON.parse(r).retry}catch{}if(n&&this.retryCount<nt)return m.debug("onErrorStatusLoaded, retry:",this.retryCount),await this.scheduler.sleep(this.retryCount*Ue+Math.random()*Ue),this.retryCount+=1,this.loadData();throw Error(n?"Too many retries":`Fetch Error: ${t} - ${r}`)}parseFullDocumentSync(t){let r=performance.now();this.documentSize=t.length;let n=JSON.parse(t);if(!Te(n.version))throw Error("cannot read document version");if(this.canvasTreeVersion=n.version,m.debug("parseFullDocumentSync",this.canvasTreeVersion,J(this.documentSize),x(this.loadingDuration)),this.emit("loadedDocumentVersion",n.version),this.scheduler.isDone())return;let s=oe(n);this.emit("loadedSomeData",s),!this.scheduler.isDone()&&(this.emit("loadedAllData"),this.parsingDuration+=performance.now()-r,P("parsingFirstPage"),m.debug("done",J(this.documentSize),"loading:",x(this.loadingDuration),"parsing:",x(this.parsingDuration)))}hasLoadedScope(t){let r=this.scopesToLoad.has(t),n=this.currentLoadingScope?.id===t;return!r&&!n}numberOfScopesToLoad(){return this.scopesToLoad.size}prioritizeLoadingScope(t,r){let n,s;if(typeof r=="function")this.addScopeLoadCallback(t,r);else if(r&&"onLoaded"in r)this.addScopeLoadCallback(t,r.onLoaded),s=r;else{let o=pe();n=o,this.addScopeLoadCallback(t,o.resolve),s=r}if(!(s?.preload&&D.isOn("debugEditWhileNeverLoadingRest")))return this.scopesToLoad.has(t)&&(this.prioritizedScopeIds.add(t),this.updatePauseResumeState(),this.addScopeLoadCallback(t,this.updatePauseResumeState)),n}nextScopeIdToLoad(){for(let r of this.prioritizedScopeIds)if(this.prioritizedScopeIds.delete(r),!!this.scopesToLoad.has(r))return this.scopesToLoad.delete(r),this.scheduler.fast(),r;let t=this.loadAllDataPriority>0;this.settings.loadInBackground&&!t?this.scheduler.slow():this.scheduler.fast();for(let r of this.scopesToLoad)return this.scopesToLoad.delete(r),r;throw Error("No next scope to load")}async loadDocumentVersion(t){this.documentSize=t.length;let r=performance.now(),n=new H(t,this.settings);return this.canvasTreeVersion=n.canvasTreeVersion,this.parsingDuration+=performance.now()-r,m.debug("loadDocumentVersion",this.canvasTreeVersion,J(this.documentSize),x(this.loadingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let s=performance.now();this.emit("loadedDocumentVersion",n.canvasTreeVersion),this.parsingDuration+=performance.now()-s}),this.partialParser=n,n}async loadFirstTree(t){let r=performance.now(),n=t.readFirstPage();this.scopesToLoad=t.getScopesToLoad();for(let s of this.scopesToLoad){let o=n.get(s);o&&(o.cache.isShallowLoad=!0)}return this.parsingDuration+=performance.now()-r,m.debug("loadFirstTree",x(this.parsingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let s=performance.now();n.setService("loader",this),this.emit("loadedSomeData",n),P("parsingFirstPage"),this.parsingDuration+=performance.now()-s}),n}hasNextScopeToLoad(){return this.scopesToLoad.size>0}async loadNextScopeAsync(t){u(!this.currentLoadingScope,"already have a currently loading scope");let r=this.nextScopeIdToLoad();this.currentLoadingScope=new G(r);let n=await this.currentLoadingScope.run(this.scheduler,t);m.debug("loadScopeAsync:",r,x(n.duration),"scheduler mode:",this.scheduler.currentMode()),n.hasNode()&&await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let s=performance.now(),o=n.take();this.currentLoadingScope=void 0,o&&(this.emit("loadedScope",o),this.parsingDuration+=n.duration+performance.now()-s,this.signalScopeLoadCallbacks(o.id))})}loadScope(t){if(u(this.partialParser,"loadScope before the parser is available"),this.currentLoadingScope?.id===t){let n=this.currentLoadingScope.force(this.partialParser);return this.parsingDuration+=n.duration,this.currentLoadingScope=void 0,n.take()}if(this.prioritizedScopeIds.delete(t),!this.scopesToLoad.has(t))return;this.scopesToLoad.delete(t);let r=new G(t).force(this.partialParser);return this.parsingDuration+=r.duration,m.debug("loadScope:",t,x(r.duration)),this.signalScopeLoadCallbacks(t),r.take()}addScopeLoadCallback(t,r){if(!r)return;if(this.hasLoadedScope(t)){setTimeout(r);return}let n=this.loadCallbacksPerScope.get(t)??[];n.push(r),this.loadCallbacksPerScope.set(t,n)}signalScopeLoadCallbacks(t){setTimeout(()=>{let r=this.loadCallbacksPerScope.get(t);if(r){for(let n of r)n();this.loadCallbacksPerScope.delete(t)}})}async emitWrapped(t){this.settings.asyncEventWrapper?(await this.scheduler.yield(),await this.settings.asyncEventWrapper(t)):(await this.scheduler.yield(),t())}resetTreeForRecovery(t){t.setService("loader",this);for(let r of this.scopesToLoad){let n=t.get(r);n&&(n.cache.isShallowLoad=!0)}this.tree=t}async nodeIdsToLoad(){let t=performance.now(),r=new Set;if(!this.partialParser)return r;let n=performance.now();for(let s of this.scopesToLoad){performance.now()-n>50&&(await W(),n=performance.now());let o=this.partialParser.getParsedPageById(s);Ve(r,o)}for(let s of this.addedByDiff)r.add(s);for(let s of this.removedByDiff)r.delete(s);return m.debug("nodeIdsToLoad",r.size,x(performance.now()-t)),r}addNodeChanges(t){for(let r of t){let n=r.id;r.added?(this.addedByDiff.add(n),this.removedByDiff.delete(n)):r.removed&&(this.addedByDiff.delete(n),this.removedByDiff.add(n))}}};function Ve(i,e){if(e&&(i.add(e.id),!!e.children))for(let t of e.children)Ve(i,t)}var $=class{constructor(e,t){this.node=e;this.duration=t}hasNode(){return!!this.node}take(){let e=this.node;return this.node=void 0,e}},G=class{constructor(e){this.id=e;a(this,"data");a(this,"loadedScope")}async run(e,t){if(this.loadedScope)return this.loadedScope;let r=performance.now();this.data=t.getParsedPageById(this.id);let n=performance.now()-r;if(await e.yield(),this.loadedScope)return this.loadedScope;let s=performance.now(),o=t.buildPage(this.data);return o&&(o.cache.isShallowLoad=!1),this.loadedScope=new $(o,n+performance.now()-s),this.loadedScope}force(e){if(this.loadedScope)return this.loadedScope;let t=performance.now();this.data||(this.data=e.getParsedPageById(this.id));let r=e.buildPage(this.data);return r&&(r.cache.isShallowLoad=!1),this.loadedScope=new $(r,performance.now()-t),this.loadedScope}};var it=y("wantsNativeTextActions");function ze(i=document.activeElement){if(!(i instanceof HTMLElement))return!1;if(i.classList.contains("wantsNativeTextAction")||i instanceof HTMLIFrameElement)return!0;if(i instanceof HTMLInputElement)switch(i.type){case"date":case"datetime-local":case"email":case"month":case"number":case"password":case"search":case"tel":case"text":case"time":case"url":case"week":return!0;case"checkbox":case"color":case"file":case"image":case"radio":case"range":case"reset":case"submit":return!1;default:return it.reportErrorOncePerMinute("Unhandled input type: "+i.type),!1}return i instanceof HTMLTextAreaElement||D.isOn("rightClickOnLinks")&&(i instanceof HTMLAnchorElement||i.closest("a"))?!0:i.isContentEditable}var I=B(me());var je=B(ge());function de(i){return i.wantsActions?i.wantsActions():!0}function ce(i,e,t){return i.wantsAction?i.wantsAction(e,t):!0}function We(i,e){return i.optionsForAction?i.optionsForAction(e):void 0}var _e;(r=>{function i(n){return new t(n)}r.chain=i;function e(n,s){return n&&n instanceof t?n.actionToTargetMap[s]:n}r.functionTarget=e;class t{constructor(s){a(this,"actionToTargetMap",{});a(this,"wantedActions",[]);this.then(s)}then(s){this.wantedActions=this.wantedActions.concat(s.wantedActions);let o=this.actionToTargetMap,d=s.wantedActions;for(let h of d)o[h]=o[h]||s;return this}wantsAction(s,o){let d=this.actionToTargetMap[s];return!d||!de(d)?!1:ce(d,s,o)}optionsForAction(s){let o=this.actionToTargetMap[s];if(o)return We(o,s)}}})(_e||={});var A=class extends Event{constructor(){super(...arguments);a(this,"actionIdentifier");a(this,"actionArgument")}};a(A,"eventType","vekter-action-dispatch-event");var M=class extends Event{constructor(){super(...arguments);a(this,"invalidatedActions");a(this,"validatedActionStates");a(this,"validatedActionOptions")}};a(M,"eventType","vekter-action-validation-event");function Yt({target:i,engine:e,children:t,style:r,global:n}){let s=(0,I.useRef)(null),o=(0,I.useCallback)(c=>{let l=c.actionIdentifier;if(!l)return;let f=_e.functionTarget(i,l);if(!f||!f.wantedActions.includes(l)||!de(f))return;let T=f[l];if(typeof T!="function")return;let C=ce(f,l,c);if(!C||(c.preventDefault(),c.stopPropagation(),C!==!0))return;e.setEditReason(l);let p=T.bind(f);e.wrapHandler(p)(c.actionArgument)},[e,i]),d=(0,I.useCallback)(c=>{let{invalidatedActions:l,validatedActionStates:f,validatedActionOptions:T}=c;if(!(!l||!f||!T)&&i){for(let C of i.wantedActions)if(l.has(C)){l.delete(C);let p=de(i)?ce(i,C,c):!1;if(f[C]=p,p===!0||p===!1){let g=We(i,C);g&&(T[C]=g)}}l.size===0&&(c.preventDefault(),c.stopPropagation())}},[i]);(0,I.useEffect)(()=>{if(!s.current)return;let c=(n?document.documentElement:null)||s.current;return c.addEventListener(A.eventType,o),c.addEventListener(M.eventType,d),()=>{c.removeEventListener(A.eventType,o),c.removeEventListener(M.eventType,d)}},[n,o,d]);let h=(0,I.useCallback)(c=>{!ze(c.target)&&!O.isDebugBuild&&c.preventDefault()},[]);return(0,je.jsx)("div",{ref:s,onContextMenu:h,style:r,children:t})}function Kt(i,e){let t=document.activeElement;if(!t)throw Error("No active element for action dispatch");let r=new A(A.eventType,{bubbles:!0});return r.actionIdentifier=i,r.actionArgument=e,t.dispatchEvent(r)}function st(i){let e=document.activeElement;if(!e)throw Error("No active element for action validation");let t=new Set;for(let o of i)t.add(o);let r={},n={},s=new M(M.eventType,{bubbles:!0});return s.invalidatedActions=t,s.validatedActionStates=r,s.validatedActionOptions=n,e.dispatchEvent(s),{states:r,options:n}}var qe=[],He=[];function Qt(i){qe.push(i)}function Zt(i){He.push(i)}function er(i){let e=i==="*"?Object.keys(X):[i];qe.forEach(n=>n());let{states:t,options:r}=st(e);Object.assign(X,t),Object.assign(Be,r);for(let n of e)X[n]=t[n]||(n==="undo"||n==="redo"||n==="delete"?"native":!1);return He.forEach(n=>n()),{states:X,options:Be}}var X={},Be={};function Je(i){if(!i.children)return;let e=new Map;for(let t of i.children)Se(t)&&e.set(t.id,{master:t,replicas:new Map});for(let t of i.children){if(!ye(t))continue;let r=e.get(t.replicaInfo.master);r&&r.replicas.set(t.id,t)}for(let{master:t,replicas:r}of e.values())ot(t,r)}function ot(i,e){for(let t of e.values()){let r=t.replicaInfo;u(r.master===i.id,"Replica must match master");let n=r.overrides;if(r.inheritsFrom){let f=e.get(r.inheritsFrom);f&&(n=be(n,f.replicaInfo.overrides))}let s=n[i.id],o=t.duplicatedFrom;te.copyToNode(t,i,s),t.duplicatedFrom=o;let d=!1;Ce(t)&&(d=!0,we(t,n,i),ee(i,t));let h=t.id,c=i.children;if(!c)return;let l=new Array(c.length);for(let f=0,T=c.length;f<T;f++)l[f]=$e(h,n,c[f],h,d);t.children=l}}function $e(i,e,t,r,n){let s=_({__class:t.__class,id:i+t.id,parentid:r});u(s,"Failed to create replica node");let o=e[t.id];if(te.copyToNode(s,t,o),s.duplicatedFrom=null,n&&ee(t,s),t.children){let d=t.children,h=new Array(d.length);for(let c=0,l=d.length;c<l;c++)h[c]=$e(i,e,d[c],s.id,n);s.children=h}return s}var v=y("tree:timeline"),le=class{constructor(e){this.nodeChangesBuffers=e;a(this,"changes",new Map);this.nodeChangesBuffers.add(this)}trackChange(e,t){let r=this.changes.get(e);if(r){t&&r.push(t);return}this.changes.set(e,t?[t]:[])}read(){let e=this.changes;return this.changes=new Map,e}clear(){this.changes=new Map}dispose(){this.nodeChangesBuffers.delete(this)}},F=class{constructor(e,t,r=[],n=!1){this.tree=e;this.changes=t;this.editReasons=r;this.wasRebase=n;a(this,"wasScopeInsert",!1);a(this,"version",0)}toDebugData(){return{version:this.version,changes:this.changes,editReasons:this.editReasons,wasScopeInsert:this.wasScopeInsert,wasRebase:this.wasRebase}}},he=class{constructor(){a(this,"idToChanges",new Map)}getChanges(){return Array.from(this.idToChanges.values())}addChanges(e){if(e)for(let t of e){let r=this.idToChanges.get(t.id);r||(r={id:t.id,to:{}},this.idToChanges.set(t.id,r)),re(r,t)}}},Y=class{constructor(e,t){a(this,"tree");a(this,"entries");a(this,"latestReversibleNodeChanges",null);a(this,"trimmed",0);a(this,"isPartialTree",!1);a(this,"isLoading",!1);a(this,"rollingDiff",null);a(this,"localChangesSentToRemote",0);a(this,"remoteTreeIndex",0);a(this,"inErrorRecovery",!1);a(this,"nodeChangesBuffers",new Set);a(this,"legacyMode",!1);a(this,"remoteTreeVersion",0);a(this,"recentEditReasons",[]);a(this,"flagsForNextCommit");a(this,"extraChangesForNextCommit");a(this,"resetTime",0);a(this,"epoch",0);this.reset(e,t)}get localTreeIndex(){return this.trimmed+this.entries.length-1}setFlagsForNextCommit(e){this.flagsForNextCommit=e}setExtraChangesForNextCommit(e){this.extraChangesForNextCommit=e}recordEditReasons(e){e&&this.recentEditReasons.push(e)}trackChange(e,t=null){for(let r of this.nodeChangesBuffers)r.trackChange(e,t)}getTreeForVersion(e){if(!this.isPartialTree&&!this.isLoading)return xe(this.entries,t=>t.version===e)?.tree}setRemoteTreeVersion(e){if(this.remoteTreeVersion=e,this.isPartialTree||this.isLoading)return;let t=this.getRemoteEntry();u(t,"remote tree is missing"),t.version=e}reset(e,t){if(this.resetTime=performance.now(),this.inErrorRecovery&&e===this.tree){v.debug("reset for error recovery..."),this.inErrorRecovery=!1,this.invalidateAllCursors(),this.clearNodeChangesReader();return}v.debug("reset with tree:",e.root.id,"size:",e.size()),this.tree=e,this.entries=[new F(e,t?.initialChanges??[],["load"])],this.recentEditReasons=[],this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,this.latestReversibleNodeChanges=null,this.localChangesSentToRemote=0,this.trimmed=0,this.remoteTreeIndex=0,this.isPartialTree=!!t?.isPartialTree,this.isLoading=!!t?.isLoading,this.isLoading&&D.isOn("rollingDiff")&&(this.rollingDiff=new he,this.rollingDiff.addChanges(t?.initialChanges)),this.invalidateAllCursors(),this.clearNodeChangesReader()}invalidateAllCursors(){this.epoch+=1}openNodeChangesReader(){return new le(this.nodeChangesBuffers)}clearNodeChangesReader(){for(let e of this.nodeChangesBuffers)e.clear()}loadOneScope(e,t=!1){v.debug("loadOneScope:",e.id),u(this.isLoading,"Must be loading"),u(!e.cache.isShallowLoad,"Scope must not be shallow");let r=this.getRemoteEntry();u(r,"remote tree is missing");let n=this.tree.isViewOnly;r.tree.editClosed=!1,r.tree.isViewOnly=!1,r.tree.inEditor=!1,r.tree.makeLatest();let s=new Set,o=r.tree.root.children.findIndex(l=>l.id===e.id);if((e.__class==="WebPageNode"||e.__class==="SmartComponentNode")&&D.isOn("expandReplicasWithoutTree")){Je(e),r.tree=r.tree.commitWithLoadedScope(e);for(let l of e.walk())this.trackChange(l.id),s.add(l.id)}else r.tree.remove(e.id),r.tree.insertNode(e,r.tree.root.id,o);if(this.rollingDiff){let l=this.rollingDiff.getChanges();s.size>0?ne(l,s)&&L(r.tree,l):L(r.tree,l)}else{let l=0,f=s.size>0,T=this.getRemoteIndex();for(let C of this.entries){if(l>T)break;l++,!C.wasScopeInsert&&(f&&!ne(C.changes,s)||(f=!1,L(r.tree,C.changes)))}}o===-1?u(!r.tree.get(e.id),"Scope must have been deleted by remote diffs"):r.tree.loadReplicasAndCodeComponents(e);let d=r.tree.commit((l,f)=>{let T=l?.id??f?.id;T&&this.trackChange(T)});r.tree.inEditor=!0,d.inEditor=!0,this.remoteTreeIndex+=1,t||(this.latestReversibleNodeChanges=null);let h=this.entries.length-this.getRemoteIndex();u(h>=0,"computed rebase is off");let c;return h===0?c=this.addRemoteTreeWithChanges(d,[]):c=this.rebaseRemoteTreeWithChanges(d,[],h),c.wasScopeInsert=!0,this.legacyMode&&this.invalidateAllCursors(),d.isViewOnly=n,this.rollingDiff&&this.trimForShallowLoading(),this.tree}loadedAllScopes(){v.info("done loading, took:",Math.round((performance.now()-this.resetTime)/100)/10,"seconds"),u(this.isLoading,"Must be in loading mode"),this.isLoading=!1,this.rollingDiff=null;let e=this.getRemoteEntry();e&&(e.version=this.remoteTreeVersion,this.trimForShallowLoading())}getRemoteEntry(){let e=this.getRemoteIndex();return this.entries[e]}getRemoteIndex(){return this.remoteTreeIndex-this.trimmed}loadCompleteTree(e,t=0){v.debug("load complete tree:",this.tree.sizeAtStart(),"->",e.size(),"entries:",this.entries.length),u(this.trimmed===0,"cannot load complete tree while having local changes"),u(!e.hasUncommittedChanges(),"tree should be clean"),this.entries.forEach((o,d)=>{d>this.remoteTreeIndex||L(e,o.changes)}),e.hasUncommittedChanges()&&(e=e.commitDiffs());let r=[],n=this.tree;if(n.sizeAtStart()*2>e.size()){let o={};for(let d of e.root.walk()){let h=n.getNodeAtStart(d.id)||void 0,c=ie(h,d);c&&(o[c.id]=c),this.trackChange(d.id,c)}r=Object.values(o),v.debug("load complete tree, diff:",r.length)}else this.invalidateAllCursors(),v.debug("load complete tree, resending:",this.tree.size());this.remoteTreeIndex+=1,this.latestReversibleNodeChanges=null;let s=this.entries.length-this.remoteTreeIndex;return u(s>=0,"computed rebase is off"),e.lineage!==this.tree.lineage?(this.reset(e),this.setRemoteTreeVersion(t),this.tree):(s===0?this.addRemoteTreeWithChanges(e,r):this.rebaseRemoteTreeWithChanges(e,r,s),this.isPartialTree=!1,this.setRemoteTreeVersion(t),this.trim(),this.tree.forEachNode(o=>this.trackChange(o.id)),this.tree)}trim(){if(this.isPartialTree||this.isLoading)return;let e=0;this.remoteTreeIndex>0?e=this.getRemoteIndex()-100:e=this.localTreeIndex-this.trimmed-100,!(e<=75)&&(this.trimmed+=e,v.debug("trim",e,"new offset:",this.trimmed,"entries.length:",this.entries.length),this.entries.splice(0,e),u(this.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}trimForShallowLoading(){if(this.isPartialTree)return;let e=this.getRemoteIndex()-3;e<=0||(this.trimmed+=e,v.debug("trim",e,"new offset:",this.trimmed,"entries.length:",this.entries.length,"after load"),this.entries.splice(0,e),u(this.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}applyFlagsToChange(e){e&&this.flagsForNextCommit&&(this.flagsForNextCommit.ignoreInUndo&&(e.ignoreInUndo=!0),this.flagsForNextCommit.ignoreInCodeGeneration&&(e.ignoreInCodeGeneration=!0))}commitLocalTree(){let e=this.entries[this.entries.length-1];u(this.tree===e.tree,"tree out of sync");let t={};this.tree=this.tree.commit((n,s)=>{if(!n&&!s)return;let o=ie(n,s);if(this.applyFlagsToChange(o),this.trackChange(n?.id??s.id,o),o){if(o.to.parentid&&o.to.parentid!==o.from?.parentid){let h=this.tree.getScopeNodeAtStartFor(n),c=this.tree.getScopeNodeFor(s);h&&h?.id!==c?.id&&(o.previousScope=h.id)}t[o.id]=o}let d=[];Ne(d,n,s);for(let h of d)this.applyFlagsToChange(h),this.trackChange(h.id,h),t[h.id]=h}),this.latestReversibleNodeChanges=Object.values(t);let r=this.latestReversibleNodeChanges;if(this.extraChangesForNextCommit){r=[...r];for(let n of this.extraChangesForNextCommit)this.applyFlagsToChange(n),this.trackChange(n.id,n),r.push(n)}return this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,v.debug("commit local tree:",r.length,this.recentEditReasons),r.length>0?(u(e.tree!==this.tree,"must be a new tree"),e.tree.releaseMemory(),this.entries.push(new F(this.tree,r,this.recentEditReasons)),this.trim()):this.tree!==e.tree&&(e.tree.releaseMemory(),e.tree=this.tree),this.recentEditReasons=[],u(this.tree===this.entries[this.entries.length-1].tree),this.tree}getLatestChangesForUndo(){return this.latestReversibleNodeChanges}getChangeTrackingCursor(){let e=this.remoteTreeIndex,t=this.localTreeIndex;return{remoteTree:e,localTree:t,timeline:this,tree:this.tree,epoch:this.epoch}}invalidatedByLoadCompletedDocument(e){return!(!e||this.trimmed>0||e.timeline!==this||e.epoch+1!==this.epoch||e.remoteTree+1!==this.remoteTreeIndex)}fetchForwardChanges(e){if(!e||e.epoch!==this.epoch||e.tree.lineage!==this.tree.lineage||e.tree.root.id!==this.tree.root.id||e.timeline!==this||e.localTree>0&&e.localTree<=this.trimmed||e.remoteTree>0&&e.remoteTree<=this.trimmed||this.remoteTreeIndex>0&&this.trimmed>0&&e.remoteTree===0)return;let t=e.localTree;if(this.remoteTreeIndex>0)for(t=e.remoteTree-1;t<e.localTree&&!this.entries[t+1-this.trimmed]?.wasRebase;)t+=1;u(t-this.trimmed>=0,"buffer cut too close to remoteTree"),u(t<=e.localTree,"startIndex incorrectly calculated");let r=this.localTreeIndex;u(t<=r,"bad change tracking cursor");let n=e.tree;return e.remoteTree=this.remoteTreeIndex,e.localTree=r,e.tree=this.tree,this.computeForwardChanges(t,r,n)}computeForwardChanges(e,t,r){if(e>=t)return[];let n={};for(let o=e+1;o<=t;o++){let d=this.entries[o-this.trimmed];for(let h of d.changes){let c=h.id,l=n[c];l||(l=n[c]={id:c,to:{}});let f=l.added;re(l,h),!r&&f&&l.removed&&delete n[c]}}let s=r??this.entries[e-this.trimmed].tree;return Object.values(n).filter(o=>{if(o.removed)return o.to={},!0;let d=s.getNodeAtStart(o.id);if(d)for(let[f,T]of Object.entries(o.to))ve(d[f],T)&&delete o.to[f];if(o.added||Object.keys(o.to).length>0)return!0;let h=o.toChildren;if(!h)return!1;if(!d)return!0;s.beginAllowPartialScopeAccess();let c=d.children;if(s.endAllowPartialScopeAccess(),!c)return!0;let l=c.length;if(l!==h.length)return!0;for(let f=0;f<l;f++)if(c[f].id!==h[f])return!0;return!1})}getUnconfirmedChangeCount(){return this.localTreeIndex-this.remoteTreeIndex}hasChangesForRemote(){let e=this.remoteTreeIndex+this.localChangesSentToRemote,t=this.localTreeIndex;return u(e<=t,"inconsistency in getting local changes to send"),e<t}hasOnlyEmptyChangesForRemote(){let e=this.remoteTreeIndex+this.localChangesSentToRemote,t=this.localTreeIndex;return e>=t?!0:this.computeForwardChanges(e,t).length===0}getEditReasons(e,t){let r=[],n="";for(let s=e+1;s<=t;s++){let o=this.entries[s-this.trimmed].editReasons;for(let d of o)d&&n!==d&&(n=d,r.push(d))}return r.join(" ")}getForwardChangesForRemote(){let e=this.remoteTreeIndex+this.localChangesSentToRemote,t=this.localTreeIndex;u(e<t,"inconsistency in getting local changes to send");let r=this.computeForwardChanges(e,t),n=t-e;this.localChangesSentToRemote+=n;let s=this.getEditReasons(e,t);return{changes:r,count:n,reasons:s}}confirmLocalChangesByRemote(e,t=0){if(u(e>=1,"cannot confirm less than one change"),u(this.localChangesSentToRemote>=e,"cannot confirm local changes that have not been sent"),u(this.remoteTreeIndex<this.localTreeIndex,"must have unconfirmed local changes"),this.rollingDiff)for(let r=1;r<=e;r++)this.rollingDiff.addChanges(this.entries[this.remoteTreeIndex+r]?.changes);return this.localChangesSentToRemote-=e,this.remoteTreeIndex+=e,this.setRemoteTreeVersion(t),this.tree}insertRemoteChanges(e,t=0){v.debug("insertRemoteChanges:",e.length),u(this.tree===this.entries[this.entries.length-1].tree,"tree out of sync"),u(this.remoteTreeIndex<=this.localTreeIndex,"remote tree too far ahead"),this.rollingDiff&&this.rollingDiff.addChanges(e);let r=this.getRemoteEntry();u(r,"remote tree is missing");let n=this.tree.isViewOnly;r.tree.editClosed=!1,r.tree.isViewOnly=!1,r.tree.makeLatest(),r.tree.beginAllowPartialScopeAccess(),L(r.tree,e);let s=r.tree.commitDiffs();for(let d of e)this.trackChange(d.id,d);for(let d of r.tree.getNodesChangedByCommit())this.trackChange(d.id);this.remoteTreeIndex+=1,this.latestReversibleNodeChanges=null;let o=this.entries.length-this.getRemoteIndex();return u(o>=0,"computed rebase is off"),o===0?this.addRemoteTreeWithChanges(s,e):this.rebaseRemoteTreeWithChanges(s,e,o),this.trim(),this.setRemoteTreeVersion(t),r.tree.endAllowPartialScopeAccess(),s.isViewOnly=n,this.tree}addRemoteTreeWithChanges(e,t){v.trace("addRemoteTreeWithChanges:",t.length),u(e.lineage===this.entries[this.entries.length-1].tree.lineage,"Trees must belong to the same line."),u(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes.");let r=this.entries[this.entries.length-1];r.tree!==e&&r.tree.releaseMemory();let n=new F(e,t);return this.entries.push(n),this.tree=e,n}rebaseRemoteTreeWithChanges(e,t,r){v.debug("rebaseRemoteTreeWithChanges:",r,"changes:",t.length),u(e.lineage===this.entries[this.entries.length-1].tree.lineage,"Trees must belong to the same line."),u(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),u(this.entries.length>=r,"rebase",r,"> commits",this.entries.length);let n=this.entries.length,s=this.entries.splice(n-r,r);u(s.length===r,"must have",r,"entries to process");let o=new F(e,t,[],!0);this.entries.push(o);let d=e;for(let h=0;h<r;h++){let c=s[h];L(e,c.changes),e=e.commitDiffs();for(let l of c.changes)this.trackChange(l.id,l);for(let l of d.getNodesChangedByCommit())this.trackChange(l.id);this.entries.push(new F(e,c.changes,c.editReasons,c.wasRebase)),e!==d&&(d.releaseMemory(),d=e)}return this.tree=e,o}debugOverwriteCurrentTree(e){v.debug("recover with tree:",e.root.id),this.tree=e,this.entries[this.entries.length-1].tree=e}resetTreesForRecovery(){v.info("reset trees for recovery, remote:",this.remoteTreeIndex,"local:",this.localTreeIndex,"changes already sent:",this.localChangesSentToRemote);let e=this.getRemoteIndex(),t=this.entries[e].tree;u(t,"unable to get remote tree");let r=t.getService("loader"),n=[];t=q(JSON.parse(JSON.stringify(t.toJS())),n),r&&(r.resetTreeForRecovery(t),u(t.getService("loader")===r,"tree must have the same loader")),n.length>0&&v.warn("[recovery] encountered errors while reloading the tree:",n),this.entries[e].tree=t,this.entries.length=1+e+this.localChangesSentToRemote;let s=t;for(e+=1;e<this.entries.length;e++){let o=this.entries[e];L(t,o.changes),t=t.commitDiffs(),o.tree=t,t!==s&&(s.releaseMemory(),s=t)}return this.inErrorRecovery=!0,this.tree=t,t}saveTimelineDataForRecovery(){if(window.localStorage)try{let e=`debugTimelineAtRecovery-${Math.floor(Math.random()*100)}`,t={date:new Date().toString(),entries:this.entries.map(r=>r.toDebugData())};window.localStorage.setItem(e,JSON.stringify(t))}catch(e){v.warn("failed to store timeline in localStorage:",e)}}};var S=B(me());var at=0,K=class{constructor(){a(this,"id",++at);a(this,"currentRtt",NaN);a(this,"rtts",[]);a(this,"rttIndex",0);a(this,"pending",Array.from(Array(128),()=>({type:"",time:0})));a(this,"start",0);a(this,"end",0);a(this,"overflow",0);a(this,"lastSendTime",0);a(this,"bytesSent",0);a(this,"bytesReceived",0)}read(){let{bytesSent:e,bytesReceived:t,id:r}=this;return this.bytesSent=0,this.bytesReceived=0,[e,t,this.rtt(),r]}computeRtt(){let e=this.rtts.length;if(e===0){this.currentRtt=NaN;return}let t=0;for(let r of this.rtts)t+=r;this.currentRtt=t/e}lastSend(){return this.lastSendTime}rtt(){return Number.isNaN(this.currentRtt)&&this.computeRtt(),Math.max(this.currentRtt||0,this.pendingRtt())}pendingRtt(){return this.start===this.end?0:performance.now()-this.pending[this.start].time}pendingCount(e){if(!e)return this.start>this.end?128-this.start+this.end:this.end-this.start;let t=0;for(let r=this.start;r!==this.end;r=r+1&127)this.pending[r].type===e&&t++;return t}sent(e,t){this.bytesSent+=t.length,this.end===(this.start===0?127:this.start-1)&&(this.start=this.start+1&127,this.overflow++);let r=this.pending[this.end];r.type=e,r.time=performance.now(),this.end=this.end+1&127,this.lastSendTime=r.time}received(e){this.bytesReceived+=e.length}acked(){if(this.start===this.end){console.warn("Called SocketStats.acked() with empty buffer");return}if(this.overflow>0){this.overflow--;return}let e=this.pending[this.start],t=performance.now()-e.time;this.rtts.length<32?this.rtts.push(t):(this.rtts[this.rttIndex]=t,this.rttIndex=this.rttIndex+1&31),this.start=this.start+1&127,this.currentRtt=NaN}};var k=y("remote:socket"),dt=16;function ct(i){switch(i){case"AccessDenied":case"ClientNeedsUpdate":case"ClientTooNew":case"DocumentNotFound":case"UnsupportedSchema":case"UnknownPermanentError":case"ClientSidePermanentError":return!1;case"ReconnectToNewServer":case"UnknownRecoverableError":case"ClientSideRecoverableError":return!0;default:return ue(i)}}function Nr({url:i,documentConnection:e,tunnel:t=null}){let r=(0,S.useRef)(null),n=(0,S.useRef)(!0),s=(0,S.useRef)({onConnect:new Set,onDisconnect:new Set,onMessage:new Set}),o=(0,S.useRef)(i),d=(0,S.useRef)(!0),h=(0,S.useRef)(void 0);function c(){h.current!==void 0&&(window.clearTimeout(h.current),h.current=void 0)}let l=(0,S.useCallback)(()=>{d.current=!1;let p=r.current;p&&p.ws.readyState<WebSocket.CLOSING&&(p.clientClosed=!0,p.ws.close())},[]),f=(0,S.useCallback)(()=>{if(c(),!d.current||r.current)return;function p(b){h.current===void 0&&(h.current=window.setTimeout(()=>{h.current=void 0,navigator.onLine&&!document.hidden&&f()},b))}let g=new URL(o.current);if(g.searchParams.set("v",dt.toString()),g.searchParams.set("tunnel",t||""),e.treeSchema<=0)return;g.searchParams.set("treeSchema",e.treeSchema.toString()),g.searchParams.set("treeVersion",e.treeVersion.toString()),k.debug("connecting to",g.href);let Ze=performance.now(),U=new WebSocket(g.href),E=new K,Q={ws:U,stats:E,clientClosed:!1};e.setSocketStats(E);let z=0;U.addEventListener("open",()=>{k.debug("open"),z=window.setInterval(()=>{if(performance.now()-E.lastSend()<1e3||E.pendingCount("ping")>1||U.readyState!==WebSocket.OPEN)return;let b="ping {}";U.send(b),E.sent("ping",b)},1e3);for(let b of s.current.onConnect)try{b(n.current)}catch(w){k.warn("Error in onConnect handler:",w)}n.current=!1}),U.addEventListener("close",b=>{let w=ht(b);if(k.debug("close:",w,"clientClosed:",Q.clientClosed,b),z!==0&&(clearInterval(z),z=0),r.current===Q){ct(w)||(d.current=!1);for(let R of s.current.onDisconnect)try{R(w)}catch(Z){k.warn("Error in onDisconnect handler:",Z)}if(r.current=null,d.current){let R=1e3;w==="ReconnectToNewServer"?R=50:performance.now()-Ze<5e3&&(R=5e3),p(R)}}}),U.addEventListener("message",b=>{try{let w=b.data;E.received(w);let R=ut(w);if(R.type==="ack"){E.acked();return}else R.type==="redirect"&&(o.current=R.value.url);for(let Z of s.current.onMessage)try{Z(R)}catch(et){k.warn("Error in onMessage handler:",et)}}catch(w){k.warn("Error receiving:",w)}}),r.current=Q},[e]);(0,S.useEffect)(()=>{f()},[f]);let T=(0,S.useCallback)(({online:p,visible:g})=>{p&&g?f():c()},[f]);return lt(T),(0,S.useMemo)(()=>({getSocketStats(){return r.current?.stats},connect(){d.current=!0,f()},disconnect(){l()},onConnect(p){return s.current.onConnect.add(p),()=>{s.current.onConnect.delete(p)}},onDisconnect(p){return s.current.onDisconnect.add(p),()=>{s.current.onDisconnect.delete(p)}},onMessage(p){return s.current.onMessage.add(p),()=>{s.current.onMessage.delete(p)}},send(p){if(!r.current||r.current.ws.readyState!==1){p.type!=="state"&&k.warn("Dropping",p.type,"message.");return}try{let g=`${p.type} ${JSON.stringify(p.value)}`;r.current.ws.send(g),r.current.stats.sent(p.type,g)}catch(g){k.warn("Error sending",p.type,"message:",g)}}}),[f,l])}function lt(i){(0,S.useEffect)(()=>{document.addEventListener("visibilitychange",e),window.addEventListener("online",e),window.addEventListener("offline",e);function e(){i({online:navigator.onLine,visible:!document.hidden})}return()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("online",e),window.removeEventListener("offline",e)}},[i])}function ht(i){switch(i.reason){case"ERR_RECONNECT_TO_NEW_SERVER":return"ReconnectToNewServer";case"ERR_ACCESS_DENIED":return"AccessDenied";case"ERR_CLIENT_NEEDS_UPDATE":return"ClientNeedsUpdate";case"ERR_DOCUMENT_NOT_FOUND":return"DocumentNotFound";case"ERR_UNSUPPORTED_SCHEMA_VERSION":return"UnsupportedSchema";case"ERR_INVALID_OPERATION":return"ClientSidePermanentError";case"ERR_UNKNOWN":return"UnknownPermanentError"}return i.code===1011?"ClientNeedsUpdate":"UnknownRecoverableError"}function ut(i){let e=i.indexOf(" "),t=i.indexOf(" ",e+1);u(e>=0&&t>=0,"Invalid data");let r=i.substring(0,e),n=i.substring(e+1,t),s=i.substring(t+1),o=JSON.parse(s);return{id:r,type:n,value:o}}function Ge(i){return typeof i=="object"&&i!==null&&"next"in i}function Xe(i){return Ge(i)&&"session"in i}function Ye(i){return Ge(i)&&"changes"in i&&Array.isArray(i.changes)}var N=y("remote:sync"),Ke=Math.pow(2,52);function Fr(i){let{session:e,seq:t,count:r,reasons:n,changes:s}=i;return{session:e,seq:t,changes:s,count:r,reasons:n}}function ft(i,e){return{...i,next:e}}var Qe=class{constructor(e=Pe.createEmpty(),t=0,r){a(this,"session",Math.floor(Math.random()*Ke));a(this,"seq",0);a(this,"treeVersion",0);a(this,"updatesSeen",0);a(this,"init",0);a(this,"expectingInitialUpdates",0);a(this,"timeline");a(this,"localUpdatesInFlight",[]);a(this,"localUpdatesAtInit",[]);a(this,"hasError",!1);a(this,"waitingForTree",!1);r?this.timeline=r:this.timeline=new Y(e),this.setTree(e,t)}get waitingForInitialUpdates(){return this.expectingInitialUpdates>this.updatesSeen}get isLoading(){return this.waitingForTree||this.waitingForInitialUpdates}get isReady(){return!(this.hasError||this.waitingForTree||this.waitingForInitialUpdates)}get tree(){return this.timeline.tree}commitAndCreateUpdate(e=0){u(O.isTest),this.timeline.commitLocalTree();let t=this.createUpdateToSend();return t?ft(t,e):null}error(e){return this.hasError=!0,Error(e)}verify(e,t){let r=this.timeline.getTreeForVersion(e);if(!r)return N.info("verify: unable to find tree with version",e),!0;let n=r.computeTreeHash();if(n!==t){if(N.warn("verify: failed",n,"!==",t),t===0)return!0;N.reportError("Tree verification failed",{localHash:n,serverHash:t,treeVersion:e,treeSize:r.size()})}else N.debug("verify: passed; hash:",t);return n===t}setTree(e,t,r){N.info("setTree",t),this.timeline.reset(e,r),r?.isPartialTree||this.timeline.setRemoteTreeVersion(t),this.treeVersion=t,this.waitingForTree=!1,this.hasError=!1,this.localUpdatesInFlight=[]}resetSession(){this.treeVersion=0,this.session=Math.floor(Math.random()*Ke),this.localUpdatesInFlight=[],this.localUpdatesAtInit=[]}debugResetSessionAndTree(e){this.resetSession(),this.setTree(e,0)}loadCompleteTree(e){this.timeline.loadCompleteTree(e,this.treeVersion)}createUpdateToSend(){if(!this.isReady)throw Error("cannot create updates while not ready");if(!this.timeline.hasChangesForRemote())return null;let{changes:e,count:t,reasons:r}=this.timeline.getForwardChangesForRemote(),n=++this.seq,s={session:this.session,seq:n,changes:e,count:t,reasons:r,confirmed:!1};return this.localUpdatesInFlight.push(s),s}handleInit(e,t,r,n){this.init+=1,this.init===1&&P("wsTreeInitMessages"),N.info("init",this.init,{treeVersion:e,initialUpdates:t,localTreeVersion:this.treeVersion}),N.debug("init updates:",{seen:this.updatesSeen,inFlight:this.localUpdatesInFlight.length,previous:this.localUpdatesAtInit.length}),this.hasError=!1,this.expectingInitialUpdates=t,this.updatesSeen=0,this.localUpdatesAtInit=this.localUpdatesInFlight.slice(),(this.treeVersion!==e||this.waitingForTree)&&(this.waitingForTree=!0,n(r,e))}handleRemoteUpdate(e){if(this.hasError||this.waitingForTree)return;u(typeof e.next=="number","must be a valid tree update");let t=e.next;if(N.trace("this:",this.session,this.seq,"at:",this.treeVersion,"update:",e),t!==this.treeVersion+1){if(t<=this.treeVersion){N.debug("ignoring old update:",t," <= ",this.treeVersion);return}throw this.error("missing update: "+this.treeVersion+" + 1 != "+t)}if(this.updatesSeen+=1,this.treeVersion=t,Xe(e)&&e.session===this.session){let r=this.localUpdatesInFlight[0];if(r?.seq===e.seq)this.localUpdatesInFlight.shift(),this.timeline.confirmLocalChangesByRemote(r.count,t),r.confirmed=!0;else{let n=this.localUpdatesAtInit.find(s=>s.seq===e.seq);if(n)this.timeline.insertRemoteChanges(n.changes,t),n.confirmed=!0;else{let s=this.localUpdatesInFlight.findIndex(d=>d.seq===e.seq),o=s===-1?"unknown local update: "+e.seq+" != "+r?.seq:"missing local update: "+e.seq+" != "+r?.seq+", is index: "+s;throw this.error(o)}}}else Ye(e)?e.changes.length>0&&this.timeline.insertRemoteChanges(e.changes,t):N.reportErrorOncePerMinute(new Error("Unknown remote update"),{update:e})}};export{ze as a,_e as b,Yt as c,Kt as d,Qt as e,Zt as f,er as g,Y as h,K as i,dt as j,ct as k,Nr as l,ht as m,ut as n,Xe as o,Ye as p,Tt as q,St as r,yt as s,oe as t,J as u,x as v,Oe as w,Fr as x,Qe as y};
//# sourceMappingURL=https://app.framerstatic.com/chunk-53K3JIKL.mjs.map
